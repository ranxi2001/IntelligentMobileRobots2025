# 基于航位推算的机器人运动估计

## 1. 实验目标
利用激光雷达数据和小车行驶轨迹数据，完成以下任务：
- 进行激光点坐标转换（从激光坐标系到全局坐标系）
- 使用简易投票法创建栅格地图

## 2. 理论基础

### 2.1 激光点坐标转换
已知：
- k时刻机器人位姿 $O_k = (x_k, y_k, a_k)$，其中$(x_k, y_k)$为位置，$a_k$为角度
- 激光点 $p_k^i$ 在激光坐标系中的坐标

求：激光点 $p_k^i$ 转换到全局坐标系 $p_w^i$

转换公式：
$$p_w^i = R_{(ak)}p_k^i + (x_k, y_k)^t$$

其中$R_{(ak)}$是旋转矩阵，表示将激光坐标系旋转到全局坐标系。

### 2.2 栅格地图创建（简易投票法）
处理步骤：
1. 栅格图初始化
   - 在全局坐标系选取原点
   - 设置栅格分辨率（resolution）
   - 设置栅格图宽度和长度（width, length）
   - 创建初始栅格图（所有格子初始值为0）

2. 激光点投影
   - 将每个激光点转换到全局坐标系
   - 投影到栅格图对应的格子中

3. 简易投票
   - 统计落入每个栅格的激光点数量(Val)
   - 点数越多，表示该栅格是障碍物的可能性越高

4. 可视化
   - 根据每个栅格中激光点的数量进行着色
   - 点数越多的栅格颜色越深，表示障碍物的可能性越高

### 2.3 时间戳匹配与数据筛选
关键问题：
- 激光雷达数据和轨迹数据的时间戳范围可能不完全一致
- 轨迹数据外的激光扫描缺乏有效的位姿参考，无法准确定位

解决方案：
1. 确定轨迹数据的时间戳范围 `[nav_start_time, nav_end_time]`
2. 筛选激光数据，只保留时间戳在轨迹范围内的帧
3. 对每个有效激光帧，找到时间最接近的轨迹位姿

这种方法可以有效避免：
- 处理没有对应位姿的冗余激光数据
- 减少因激光雷达启动早于轨迹记录导致的定位错误
- 确保地图生成更加准确可靠

## 3. 数据说明

### 3.1 设备信息
- **设备型号**：Hokuyo UTM/UXM
- **扫描参数**：
  - 扫描范围：0°~180° (最大支持-45°~225°)
  - 扫描解析度：0.5°
  - 扫描频率：约25Hz

### 3.2 数据文件格式

#### 3.2.1 轨迹数据 (ld.nav)
包含SLAM估计的车辆位置序列，格式如下：
```
time  ang.x  ang.y  ang.z  shv.x  shv.y  shv.z 
53301207  0  0  -0.104755  0.064000  0.032000  0 
```

字段说明：
- time：时间戳（毫秒）
- ang.x：横滚角（弧度）
- ang.y：俯仰角（弧度）
- ang.z：航向角（弧度）
- shv.x：X轴位移（米）
- shv.y：Y轴位移（米）
- shv.z：Z轴位移（米）

注意：二维定位时，横滚角=0，俯仰角=0，Z轴位移=0

#### 3.2.2 激光扫描数据 (URG_X_20130903_195003.lms)
二进制文件格式，包含：

1. 文件头部结构：
```c
typedef struct {
    float AngRng;    // 激光扫描范围（180°）
    float AngRes;    // 角分辨率
    float unit;      // 单位
} header;
```

2. 数据体结构：
```c
typedef struct {
    long milli;      // 时间戳
    unsigned short dat[MAXDATLEN];  // 激光数据
} LMSDATBUF;
```

其中：
- MAXDATLEN = AngRng/AngRes + 1
- 示例：当AngRng=180.0，AngRes=0.5时，MAXDATLEN = 361
- 距离计算：实际距离(米) = dat/unit

#### 3.2.3 时间戳对齐问题
经过分析，激光雷达数据文件中的时间戳范围与轨迹数据文件的时间戳范围并不完全一致。激光雷达通常会先于轨迹记录开始工作，导致有一部分激光数据没有对应的轨迹位姿。这要求我们在处理时需要进行时间戳筛选，只使用有对应轨迹的激光数据。

## 4. 代码实现流程

1. 读取激光雷达数据文件和轨迹数据文件
2. 确定轨迹数据的时间戳范围
3. 筛选出在轨迹时间范围内的激光数据帧
4. 对每帧有效激光数据：
   - 查找最近时间戳的机器人位姿
   - 将激光点从激光坐标系转换到全局坐标系
   - 更新栅格地图（投票法）
5. 可视化栅格地图和机器人轨迹

## 5. 作业要求
1. 编程语言：Python/C/C++
2. 完成激光点坐标转换
3. 实现简易投票法创建栅格地图
4. 生成并保存栅格地图

## 6. 提交要求
- 提交内容：
  - 源代码
  - 实验报告（1页以上）
- 截止时间：3月23日
