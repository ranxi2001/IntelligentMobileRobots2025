# 作业3：ROS2实现

## 学习目标
- 掌握ROS2最新版本的基本概念和使用方法
- 学习ROS2节点通信、话题订阅与发布
- 了解rosbag数据记录和回放机制

## 任务说明

本作业基于作业2进行ROS2框架的重新实现，主要包括以下内容：

1. 将原始的LMS激光雷达数据和NAV轨迹数据转换为ROS2 bag格式
2. 开发ROS2节点，接收rosbag数据并实现占用栅格地图生成功能

## 目录结构

```
work3/
├── setup.sh                   # 工作空间设置脚本
├── run.sh                     # 运行脚本
├── src/                       # 源代码目录
│   ├── lms_data/              # 数据转换包
│   │   ├── lms_data/
│   │   │   └── lms_to_rosbag.py  # 数据转换节点
│   │   ├── package.xml
│   │   └── setup.py
│   └── lms_mapper/            # 地图生成包
│       ├── lms_mapper/
│       │   └── lms_mapper_node.py  # 地图生成节点
│       ├── package.xml
│       └── setup.py
└── README.md                  # 项目说明文件
```

## 功能模块说明

### 1. 数据转换模块 (lms_data)

将原始的LMS激光雷达数据和NAV轨迹数据转换为ROS2标准消息格式，并保存为rosbag文件：

- 激光数据转换为 `sensor_msgs/LaserScan` 消息
- 轨迹数据转换为 `nav_msgs/Odometry` 消息和 `tf2_msgs/TFMessage` 消息
- 创建了 `/scan`、`/odom` 和 `/tf` 三个标准ROS2话题

### 2. 栅格地图生成模块 (lms_mapper)

接收rosbag数据，进行激光数据处理和占用栅格地图生成：

- 订阅 `/scan` 和 `/odom` 话题
- 将激光数据从激光坐标系转换到全局坐标系
- 使用逆传感器模型更新占用栅格地图
- 定期发布 `/map` 话题 (nav_msgs/OccupancyGrid)
- 将栅格地图保存为图像文件

## 运行方法

在工作目录中执行以下命令：

```bash
# 1. 确保脚本可执行
chmod +x setup.sh run.sh

# 2. 执行运行脚本
./run.sh
```

脚本将自动执行以下步骤：
1. 创建ROS2工作空间结构
2. 构建ROS2包
3. 将原始数据转换为rosbag格式
4. 启动地图生成节点
5. 播放rosbag数据
6. 生成并保存占用栅格地图

## 输出结果

成功执行后，将生成以下文件：
- `lms_data.bag`: 转换后的ROS2 bag数据文件
- `occupancy_grid.png`: 生成的占用栅格地图图像

## ROS2相关技术应用

本作业应用了以下ROS2技术：

1. **ROS2包结构**: 使用标准的ROS2 Python包结构
2. **消息类型**: 使用标准ROS2消息类型进行通信
3. **节点通信**: 实现了发布者/订阅者模式
4. **参数系统**: 使用ROS2参数系统配置节点行为
5. **rosbag2**: 使用rosbag2进行数据记录和回放
6. **坐标变换**: 使用tf2实现坐标系转换

## 与ROS1版本的对比

与ROS1相比，ROS2具有以下优势：

1. **实时性**: 基于DDS中间件，提供更好的实时性能
2. **安全性**: 提供内置的安全功能
3. **跨平台**: 支持更多操作系统
4. **模块化**: 更加模块化的设计
5. **QoS**: 提供服务质量设置
6. **多节点支持**: 更好的多节点、多进程支持

## 基本要求
- 选择之前完成的作业1或作业2中的一个任务（**选择作业2将获得加分**）
- 使用ROS2框架重新实现该任务
- 完成以下两个关键步骤：
  1. 编写代码将原始数据转换为rosbag格式
  2. 编写ROS2节点，接收rosbag数据并实现对应功能

## 技术要求
- 编程语言：Python/C/C++均可
- 需使用ROS2最新稳定版本
- 代码应遵循ROS2的标准规范

## 提交内容
- 完整源代码（包含注释）
- 技术报告（至少1页）：
  - 描述实现思路
  - 说明ROS2节点设计
  - 展示运行结果
  - 与ROS1版本对比（如有）

## 截止日期
- 2024年3月23日

## 参考资源
- [ROS2官方文档](https://docs.ros.org/en/humble/index.html)
- [ROS2 Tutorials](https://docs.ros.org/en/humble/Tutorials.html)
- [rosbag2使用指南](https://docs.ros.org/en/humble/Tutorials/Ros2bag/Recording-And-Playing-Back-Data.html)


cd /IntelligentMobileRobots2025/work3 && chmod +x 03_map_generation.sh && ./03_map_generation.sh



分辨率与地图大小

这里有一个关键限制：world_to_grid函数会将坐标限制在(0, 0)到(size_x-1, size_y-1)的范围内。
世界坐标的值：
如果地图原点(origin_x, origin_y)设置在地图中心(map_size//2, map_size//2)，那么超出地图中心一定范围的点会被截断。
分辨率影响：
resolution参数（默认0.2）影响世界坐标到栅格坐标的转换比例。世界坐标需要除以分辨率才能转换为栅格坐标。

具体计算
假设：
地图尺寸map_size = 500
原点位置(origin_x, origin_y) = (250, 250)（地图中心）
分辨率resolution = 0.2（每格代表0.2米）
对于世界坐标(x, y)=(26, 26)：
grid_x = origin_x + x/resolution = 250 + 26/0.2 = 250 + 130 = 380
grid_y = origin_y + y/resolution = 250 + 26/0.2 = 250 + 130 = 380
这些坐标在地图范围内(0-499)，所以可以正确绘制。
但如果世界坐标超过(50, 50)：
grid_x = 250 + 50/0.2 = 250 + 250 = 500，超出了地图大小499
函数会将其限制在grid_x = min(500, 499) = 499
改进建议
如果需要支持更大范围的坐标，可以：
增加地图尺寸(map_size)
调整分辨率(resolution)为更大值，减少每个实际距离占用的格子数
修改world_to_grid函数，不限制坐标范围，而是动态扩展地图大小
希望这个分析对您有所帮助！


分析与计算
根据您分享的地图图像，可以看到障碍物形成了一个方形轮廓，坐标范围大约为(-20,40)×(-10,50)米。
我来计算几种分辨率选项的效果：
当前设置
地图尺寸：1000×1000格
分辨率：0.1米/格
理论覆盖范围：1000×0.1=100米（从地图中心向四周各延伸50米）



优化选项
分辨率0.05米/格：
覆盖范围：1000×0.05=50米（从中心向四周延伸25米）
优点：细节更清晰
缺点：可能不足以覆盖全部区域
分辨率0.08米/格：
覆盖范围：1000×0.08=80米（从中心向四周延伸40米）
优点：平衡了细节和覆盖范围
缺点：略微降低了覆盖范围，但仍足够
地图尺寸与分辨率组合优化：
地图尺寸：800×800格
分辨率：0.075米/格
覆盖范围：800×0.075=60米（从中心向四周延伸30米）
优点：提高了清晰度，降低了内存消耗
建议修改
根据计算和您的需求，我建议将分辨率设置为0.075米/格，同时将地图尺寸调整为800×800格。这个组合能够：
覆盖大约±30米的区域，足够显示当前环境
提供足够的细节清晰度
相比1000×1000的地图减少了36%的内存占用