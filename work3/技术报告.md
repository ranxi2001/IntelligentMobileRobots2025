# 作业3: ROS2实现技术报告

## 1. 实现思路

本次作业基于作业2的激光雷达数据处理和占用栅格地图生成功能，使用ROS2框架进行重新实现。整体思路分为两个主要步骤：

### 1.1 数据转换

首先需要将原始的LMS激光雷达数据和NAV轨迹数据转换为ROS2标准的消息格式，并保存为rosbag文件。这一步是必要的，因为ROS2使用标准的消息类型进行通信，而原始数据是自定义的二进制格式。

具体转换流程：
1. 读取LMS文件中的激光雷达数据
2. 读取NAV文件中的轨迹数据
3. 确定轨迹的时间范围，筛选有效的激光扫描数据
4. 为每帧激光数据创建LaserScan消息
5. 为每个轨迹点创建Odometry消息
6. 创建TF坐标变换消息，建立odom->base_link->laser的坐标系关系
7. 将所有消息写入rosbag文件

### 1.2 地图生成

然后，开发ROS2节点，接收rosbag数据并实现占用栅格地图生成功能。这一步是将作业2中的地图生成算法适配到ROS2框架下。

具体实现流程：
1. 创建ROS2节点，订阅激光扫描和里程计话题
2. 在回调函数中处理接收到的数据
3. 将激光数据从激光坐标系转换到世界坐标系
4. 使用逆传感器模型更新占用栅格地图
5. 定期发布OccupancyGrid消息
6. 保存最终生成的地图为图像文件

## 2. ROS2节点设计

### 2.1 lms_data包

该包负责将原始数据转换为ROS2 bag格式，包含以下组件：

#### 2.1.1 lms_to_rosbag节点

- **功能**: 读取LMS和NAV文件，转换为ROS2标准消息格式，并保存为rosbag文件
- **输入**: LMS文件路径、NAV文件路径、输出bag路径
- **输出**: ROS2 bag文件，包含以下话题：
  - `/scan`: sensor_msgs/LaserScan
  - `/odom`: nav_msgs/Odometry
  - `/tf`: tf2_msgs/TFMessage

#### 2.1.2 主要函数设计

| 函数名称 | 功能描述 |
|---------|---------|
| `read_lms_file` | 读取激光雷达扫描数据文件 |
| `read_trajectory_file` | 读取轨迹数据文件 |
| `create_laser_msg` | 从激光扫描数据创建LaserScan消息 |
| `create_odom_msg` | 从轨迹数据创建Odometry消息 |
| `create_tf_msg` | 从轨迹数据创建TF消息 |
| `ros_time_from_ms` | 将毫秒时间戳转换为ROS2的Time消息 |
| `euler_to_quaternion` | 将欧拉角转换为四元数 |

### 2.2 lms_mapper包

该包负责接收rosbag数据并生成占用栅格地图，包含以下组件：

#### 2.2.1 lms_mapper_node节点

- **功能**: 订阅激光扫描和里程计话题，生成占用栅格地图
- **订阅话题**:
  - `/scan`: sensor_msgs/LaserScan
  - `/odom`: nav_msgs/Odometry
- **发布话题**:
  - `/map`: nav_msgs/OccupancyGrid

#### 2.2.2 OccupancyGridMapper类

- **功能**: 维护和更新占用栅格地图
- **主要方法**:
  - `update_map`: 使用激光点更新占用栅格地图
  - `ray_trace`: 使用Bresenham算法进行光线追踪
  - `get_ros_occupancy_grid`: 获取ROS OccupancyGrid消息
  - `visualize_map`: 可视化占用栅格地图并保存为图像

#### 2.2.3 参数设计

节点支持以下ROS2参数：

| 参数名称 | 数据类型 | 默认值 | 描述 |
|---------|---------|-------|------|
| `map_resolution` | double | 0.1 | 栅格地图分辨率（米/格） |
| `map_size_x` | int | 1000 | 栅格地图X轴尺寸（格数） |
| `map_size_y` | int | 1000 | 栅格地图Y轴尺寸（格数） |
| `map_update_rate` | double | 5.0 | 地图更新频率（Hz） |
| `map_save_path` | string | 'occupancy_grid.png' | 地图保存路径 |

## 3. ROS2框架优势

与作业2的直接实现相比，使用ROS2框架有以下优势：

1. **标准化**: 使用标准的ROS2消息类型，便于与其他ROS2组件集成
2. **模块化**: 将功能分解为独立的节点，便于维护和扩展
3. **通信机制**: 利用发布/订阅模式，简化了数据传输
4. **可视化工具**: 可以使用ROS2的rviz2等工具进行实时可视化
5. **参数配置**: 使用ROS2参数系统，便于动态配置
6. **数据回放**: 使用rosbag2可以方便地记录和回放数据

## 4. 运行结果

成功运行后，系统生成了占用栅格地图，并保存为图像文件。地图清晰地显示了环境中的障碍物和空闲区域，以及机器人的运动轨迹。

整个处理流程中，我们关注以下几个关键指标：

1. **数据转换效率**: 转换过程高效完成，成功筛选有效的激光扫描数据
2. **地图精度**: 生成的栅格地图准确反映了环境结构
3. **计算性能**: ROS2节点处理数据的速度满足实时要求
4. **资源占用**: 内存和CPU占用在合理范围内

## 5. 技术创新点

本实现在作业2基础上做了以下技术创新：

1. **逆传感器模型**: 使用基于光线追踪的方法更新地图，提高了精度
2. **坐标变换链**: 建立了完整的坐标变换链（odom->base_link->laser）
3. **参数化设计**: 使用ROS2参数系统，便于调整算法参数
4. **可视化增强**: 使用更丰富的可视化效果，显示轨迹和地图

## 6. 未来改进方向

虽然当前实现已经达到了作业要求，但仍有以下改进方向：

1. **地图优化**: 引入概率更新模型，提高地图准确性
2. **SLAM集成**: 与ROS2的SLAM算法集成，实现同时定位与地图构建
3. **多传感器融合**: 支持多种传感器数据的融合
4. **实时性能优化**: 进一步优化代码，提高实时性能
5. **导航功能**: 基于生成的地图，实现自主导航功能

## 7. 结论

通过本次作业，成功使用ROS2框架重新实现了作业2中的激光雷达数据处理和占用栅格地图生成功能。实现了数据转换、坐标变换、地图构建等核心功能。与直接实现相比，ROS2框架提供了更好的模块化、标准化和扩展性，为后续功能扩展打下了良好基础。 